{"name":"systemd-cryptenroll","description":"systemd-cryptenroll - Enroll PKCS#11, FIDO2, TPM2 token/devices to LUKS2 encrypted volumes","body":"\n\n<h1 align=\"center\">SYSTEMD-CRYPTENROLL</h1>\n\n\n\n\n\n\n\n\n\n<hr>\n\n\n<h2>NAME\n<a name=\"NAME\"></a>\n</h2>\n\n\n\n<p style=\"margin-left:11%; margin-top: 1em\">systemd-cryptenroll\n- Enroll PKCS#11, FIDO2, TPM2 token/devices to LUKS2\nencrypted volumes</p>\n\n<h2>SYNOPSIS\n<a name=\"SYNOPSIS\"></a>\n</h2>\n\n\n<table width=\"100%\" border=\"0\" rules=\"none\" frame=\"void\"\n       cellspacing=\"0\" cellpadding=\"0\">\n<tr valign=\"top\" align=\"left\">\n<td width=\"11%\"></td>\n<td width=\"63%\">\n\n\n<p style=\"margin-top: 1em\"><b>systemd-cryptenroll\n[OPTIONS...] [DEVICE]</b></p></td>\n<td width=\"26%\">\n</td></tr>\n</table>\n\n<h2>DESCRIPTION\n<a name=\"DESCRIPTION\"></a>\n</h2>\n\n\n\n<p style=\"margin-left:11%; margin-top: 1em\"><b>systemd-cryptenroll</b>\nis a tool for enrolling hardware security tokens and devices\ninto a LUKS2 encrypted volume, which may then be used to\nunlock the volume during boot. Specifically, it supports\ntokens and credentials of the following kind to be\nenrolled:</p>\n\n<p style=\"margin-left:17%; margin-top: 1em\">1. PKCS#11\nsecurity tokens and smartcards that may carry an RSA key\npair (e.g. various YubiKeys)</p>\n\n<p style=\"margin-left:17%; margin-top: 1em\">2. FIDO2\nsecurity tokens that implement the &quot;hmac-secret&quot;\nextension (most FIDO2 keys, including YubiKeys)</p>\n\n<p style=\"margin-left:17%; margin-top: 1em\">3. TPM2\nsecurity devices</p>\n\n<p style=\"margin-left:17%; margin-top: 1em\">4. Recovery\nkeys. These are similar to regular passphrases, however are\nrandomly generated on the computer and thus generally have\nhigher entropy than user chosen passphrases. Their character\nset has been designed to ensure they are easy to type in,\nwhile having high entropy. They may also be scanned off\nscreen using QR codes. Recovery keys may be used for\nunlocking LUKS2 volumes wherever passphrases are accepted.\nThey are intended to be used in combination with an enrolled\nhardware security token, as a recovery option when the token\nis lost.</p>\n\n<p style=\"margin-left:17%; margin-top: 1em\">5. Regular\npassphrases</p>\n\n<p style=\"margin-left:11%; margin-top: 1em\">In addition,\nthe tool may be used to enumerate currently enrolled\nsecurity tokens and wipe a subset of them. The latter may be\ncombined with the enrollment operation of a new security\ntoken, in order to update or replace enrollments.</p>\n\n<p style=\"margin-left:11%; margin-top: 1em\">The tool\nsupports only LUKS2 volumes, as it stores token\nmeta-information in the LUKS2 JSON token area, which is not\navailable in other encryption formats.</p>\n\n<h2>LIMITATIONS\n<a name=\"LIMITATIONS\"></a>\n</h2>\n\n\n<p style=\"margin-left:11%; margin-top: 1em\">Note that\ncurrently when enrolling a new key of one of the five\nsupported types listed above, it is required to first\nprovide a passphrase or recovery key (i.e. one of the latter\ntwo key types). For example, it's currently not possible to\nunlock a device with a FIDO2 key in order to enroll a new\nFIDO2 key. Instead, in order to enroll a new FIDO2 key, it\nis necessary to provide an already enrolled regular\npassphrase or recovery key. Thus, if in future key roll-over\nis desired it's generally recommended to combine TPM2,\nFIDO2, PKCS#11 key enrollment with enrolling a regular\npassphrase or recovery key.</p>\n\n<p style=\"margin-left:11%; margin-top: 1em\">Also note that\nsupport for enrolling multiple FIDO2 tokens is currently not\ntoo useful, as while unlocking <b>systemd-cryptsetup</b>\ncannot identify which token is currently plugged in and thus\ndoes not know which authentication request to send to the\ndevice. This limitation does not apply to tokens enrolled\nvia PKCS#11 &mdash; because tokens of this type may be\nidentified immediately, before authentication.</p>\n\n<h2>OPTIONS\n<a name=\"OPTIONS\"></a>\n</h2>\n\n\n<p style=\"margin-left:11%; margin-top: 1em\">The following\noptions are understood:</p>\n\n\n<p style=\"margin-left:11%; margin-top: 1em\"><b>--password</b></p>\n\n<p style=\"margin-left:17%;\">Enroll a regular\npassword/passphrase. This command is mostly equivalent to\n<b>cryptsetup luksAddKey</b>, however may be combined with\n<b>--wipe-slot=</b> in one call, see below.</p>\n\n\n<p style=\"margin-left:11%; margin-top: 1em\"><b>--recovery-key</b></p>\n\n<p style=\"margin-left:17%;\">Enroll a recovery key. Recovery\nkeys are most identical to passphrases, but are computer\ngenerated instead of human chosen, and thus have a\nguaranteed high entropy. The key uses a character set that\nis easy to type in, and may be scanned off screen via a QR\ncode.</p>\n\n\n<p style=\"margin-left:11%; margin-top: 1em\"><b>--pkcs11-token-uri=</b><i>URI</i></p>\n\n<p style=\"margin-left:17%;\">Enroll a PKCS#11 security token\nor smartcard (e.g. a YubiKey). Expects a PKCS#11 smartcard\nURI referring to the token. Alternatively the special value\n&quot;auto&quot; may be specified, in order to automatically\ndetermine the URI of a currently plugged in security token\n(of which there must be exactly one). The special value\n&quot;list&quot; may be used to enumerate all suitable\nPKCS#11 tokens currently plugged in. The security token must\ncontain an RSA key pair which is used to encrypt the\nrandomly generated key that is used to unlock the LUKS2\nvolume. The encrypted key is then stored in the LUKS2 JSON\ntoken header area.</p>\n\n<p style=\"margin-left:17%; margin-top: 1em\">In order to\nunlock a LUKS2 volume with an enrolled PKCS#11 security\ntoken, specify the <b>pkcs11-uri=</b> option in the\nrespective /etc/crypttab line:</p>\n\n<p style=\"margin-left:23%; margin-top: 1em\">myvolume\n/dev/sda1 - pkcs11-uri=auto</p>\n\n<p style=\"margin-left:17%; margin-top: 1em\">See\n<a href=\"https://man.page/5/crypttab\">crypttab(5)</a> for a more comprehensive example of a\n<b>systemd-cryptenroll</b> invocation and its matching\n/etc/crypttab line.</p>\n\n\n<p style=\"margin-left:11%; margin-top: 1em\"><b>--fido2-device=</b><i>PATH</i></p>\n\n<p style=\"margin-left:17%;\">Enroll a FIDO2 security token\nthat implements the &quot;hmac-secret&quot; extension (e.g.\na YubiKey). Expects a hidraw device referring to the FIDO2\ndevice (e.g. /dev/hidraw1). Alternatively the special value\n&quot;auto&quot; may be specified, in order to automatically\ndetermine the device node of a currently plugged in security\ntoken (of which there must be exactly one). The special\nvalue &quot;list&quot; may be used to enumerate all suitable\nFIDO2 tokens currently plugged in. Note that many hardware\nsecurity tokens that implement FIDO2 also implement the\nolder PKCS#11 standard. Typically FIDO2 is preferable, given\nit's simpler to use and more modern.</p>\n\n<p style=\"margin-left:17%; margin-top: 1em\">In order to\nunlock a LUKS2 volume with an enrolled FIDO2 security token,\nspecify the <b>fido2-device=</b> option in the respective\n/etc/crypttab line:</p>\n\n<p style=\"margin-left:23%; margin-top: 1em\">myvolume\n/dev/sda1 - fido2-device=auto</p>\n\n<p style=\"margin-left:17%; margin-top: 1em\">See\n<a href=\"https://man.page/5/crypttab\">crypttab(5)</a> for a more comprehensive example of a\n<b>systemd-cryptenroll</b> invocation and its matching\n/etc/crypttab line.</p>\n\n\n<p style=\"margin-left:11%; margin-top: 1em\"><b>--fido2-with-client-pin=</b><i>BOOL</i></p>\n\n<p style=\"margin-left:17%;\">When enrolling a FIDO2 security\ntoken, controls whether to require the user to enter a PIN\nwhen unlocking the volume (the FIDO2 &quot;clientPin&quot;\nfeature). Defaults to &quot;yes&quot;. (Note: this setting\nis without effect if the security token does not support the\n&quot;clientPin&quot; feature at all, or does not allow\nenabling or disabling it.)</p>\n\n\n<p style=\"margin-left:11%; margin-top: 1em\"><b>--fido2-with-user-presence=</b><i>BOOL</i></p>\n\n<p style=\"margin-left:17%;\">When enrolling a FIDO2 security\ntoken, controls whether to require the user to verify\npresence (tap the token, the FIDO2 &quot;up&quot; feature)\nwhen unlocking the volume. Defaults to &quot;yes&quot;.\n(Note: this setting is without effect if the security token\ndoes not support the &quot;up&quot; feature at all, or does\nnot allow enabling or disabling it.)</p>\n\n\n<p style=\"margin-left:11%; margin-top: 1em\"><b>--fido2-with-user-verification=</b><i>BOOL</i></p>\n\n<p style=\"margin-left:17%;\">When enrolling a FIDO2 security\ntoken, controls whether to require user verification when\nunlocking the volume (the FIDO2 &quot;uv&quot; feature).\nDefaults to &quot;no&quot;. (Note: this setting is without\neffect if the security token does not support the\n&quot;uv&quot; feature at all, or does not allow enabling or\ndisabling it.)</p>\n\n\n<p style=\"margin-left:11%; margin-top: 1em\"><b>--tpm2-device=</b><i>PATH</i></p>\n\n<p style=\"margin-left:17%;\">Enroll a TPM2 security chip.\nExpects a device node path referring to the TPM2 chip (e.g.\n/dev/tpmrm0). Alternatively the special value\n&quot;auto&quot; may be specified, in order to automatically\ndetermine the device node of a currently discovered TPM2\ndevice (of which there must be exactly one). The special\nvalue &quot;list&quot; may be used to enumerate all suitable\nTPM2 devices currently discovered.</p>\n\n<p style=\"margin-left:17%; margin-top: 1em\">In order to\nunlock a LUKS2 volume with an enrolled TPM2 security chip,\nspecify the <b>tpm2-device=</b> option in the respective\n/etc/crypttab line:</p>\n\n<p style=\"margin-left:23%; margin-top: 1em\">myvolume\n/dev/sda1 - tpm2-device=auto</p>\n\n<p style=\"margin-left:17%; margin-top: 1em\">See\n<a href=\"https://man.page/5/crypttab\">crypttab(5)</a> for a more comprehensive example of a\n<b>systemd-cryptenroll</b> invocation and its matching\n/etc/crypttab line.</p>\n\n<p style=\"margin-left:17%; margin-top: 1em\">Use\n<b>--tpm2-pcrs=</b> (see below) to configure which TPM2 PCR\nindexes to bind the enrollment to.</p>\n\n\n<p style=\"margin-left:11%; margin-top: 1em\"><b>--tpm2-pcrs=</b>\n[PCR...]</p>\n\n<p style=\"margin-left:17%;\">Configures the TPM2 PCRs\n(Platform Configuration Registers) to bind the enrollment\nrequested via <b>--tpm2-device=</b> to. Takes a\n&quot;+&quot; separated list of numeric PCR indexes in the\nrange 0...23. If not used, defaults to PCR 7 only. If an\nempty string is specified, binds the enrollment to no PCRs\nat all. PCRs allow binding the enrollment to specific\nsoftware versions and system state, so that the enrolled\nunlocking key is only accessible (may be\n&quot;unsealed&quot;) if specific trusted software and/or\nconfiguration is used.</p>\n\n\n<p style=\"margin-left:17%; margin-top: 1em\"><b>Table&nbsp;1.&nbsp;Well-known\nPCR Definitions</b></p></table>\n\n\n<p align=\"center\"><b><img src=\"grohtml-1345221.png\" alt=\"Image grohtml-1345221.png\"></b></p>\n\n\n<p style=\"margin-left:11%; margin-top: 1em\"><b>--wipe-slot=</b>\n[SLOT...]</p>\n\n<p style=\"margin-left:17%;\">Wipes one or more LUKS2 key\nslots. Takes a comma separated list of numeric slot indexes,\nor the special strings &quot;all&quot; (for wiping all key\nslots), &quot;empty&quot; (for wiping all key slots that are\nunlocked by an empty passphrase), &quot;password&quot; (for\nwiping all key slots that are unlocked by a traditional\npassphrase), &quot;recovery&quot; (for wiping all key slots\nthat are unlocked by a recovery key), &quot;pkcs11&quot;\n(for wiping all key slots that are unlocked by a PKCS#11\ntoken), &quot;fido2&quot; (for wiping all key slots that are\nunlocked by a FIDO2 token), &quot;tpm2&quot; (for wiping all\nkey slots that are unlocked by a TPM2 chip), or any\ncombination of these strings or numeric indexes, in which\ncase all slots matching either are wiped. As safety\nprecaution an operation that wipes all slots without\nexception (so that the volume cannot be unlocked at all\nanymore, unless the volume key is known) is refused.</p>\n\n<p style=\"margin-left:17%; margin-top: 1em\">This switch may\nbe used alone, in which case only the requested wipe\noperation is executed. It may also be used in combination\nwith any of the enrollment options listed above, in which\ncase the enrollment is completed first, and only when\nsuccessful the wipe operation executed &mdash; and the newly\nadded slot is always excluded from the wiping. Combining\nenrollment and slot wiping may thus be used to update\nexisting enrollments:</p>\n\n\n<p style=\"margin-left:23%; margin-top: 1em\">systemd-cryptenroll\n/dev/sda1 --wipe-slot=tpm2 --tpm2-device=auto</p>\n\n<p style=\"margin-left:17%; margin-top: 1em\">The above\ncommand will enroll the TPM2 chip, and then wipe all\npreviously created TPM2 enrollments on the LUKS2 volume,\nleaving only the newly created one. Combining wiping and\nenrollment may also be used to replace enrollments of\ndifferent types, for example for changing from a PKCS#11\nenrollment to a FIDO2 one:</p>\n\n\n<p style=\"margin-left:23%; margin-top: 1em\">systemd-cryptenroll\n/dev/sda1 --wipe-slot=pkcs11 --fido2-device=auto</p>\n\n<p style=\"margin-left:17%; margin-top: 1em\">Or for\nreplacing an enrolled empty password by TPM2:</p>\n\n\n<p style=\"margin-left:23%; margin-top: 1em\">systemd-cryptenroll\n/dev/sda1 --wipe-slot=empty --tpm2-device=auto</p>\n\n<p style=\"margin-left:11%; margin-top: 1em\"><b>-h</b>,\n<b>--help</b></p>\n\n<p style=\"margin-left:17%;\">Print a short help text and\nexit.</p>\n\n\n<p style=\"margin-left:11%; margin-top: 1em\"><b>--version</b></p>\n\n<p style=\"margin-left:17%;\">Print a short version string\nand exit.</p>\n\n<h2>EXIT STATUS\n<a name=\"EXIT STATUS\"></a>\n</h2>\n\n\n<p style=\"margin-left:11%; margin-top: 1em\">On success, 0\nis returned, a non-zero failure code otherwise.</p>\n\n<h2>SEE ALSO\n<a name=\"SEE ALSO\"></a>\n</h2>\n\n\n\n<p style=\"margin-left:11%; margin-top: 1em\"><a href=\"https://man.page/1/systemd\">systemd(1)</a>,\n<b>systemd-cryptsetup@.service</b>(8), <a href=\"https://man.page/5/crypttab\">crypttab(5)</a>,\n<b>cryptsetup</b>(8)</p>\n<hr>\n","headings":["<a href=\"#NAME\">NAME</a>","<a href=\"#SYNOPSIS\">SYNOPSIS</a>","<a href=\"#DESCRIPTION\">DESCRIPTION</a>","<a href=\"#LIMITATIONS\">LIMITATIONS</a>","<a href=\"#OPTIONS\">OPTIONS</a>","<a href=\"#EXIT STATUS\">EXIT STATUS</a>","<a href=\"#SEE ALSO\">SEE ALSO</a>"]}